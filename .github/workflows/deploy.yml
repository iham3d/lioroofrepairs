name: Deploy to Plesk

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Plesk via SSH
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.PLESK_HOST }}
          REMOTE_USER: ${{ secrets.PLESK_USER }}
          SOURCE: "."
          TARGET: ${{ secrets.PLESK_WEB_ROOT }}
          EXCLUDE: "/node_modules/, /.git/, /.github/, /.next/"
          SCRIPT_BEFORE: |
            cd ${{ secrets.PLESK_WEB_ROOT }}
            echo "Preparing deployment..."
          SCRIPT_AFTER: |
            cd ${{ secrets.PLESK_WEB_ROOT }}
            echo "Installing dependencies..."
            npm ci
            echo "Generating Prisma client..."
            npx prisma generate
            echo "Running database migrations..."
            npx prisma migrate deploy
            echo "Building Next.js application..."
            npm run build
            echo "Restarting application..."
            pm2 restart lioroofrepairs || pm2 start npm --name "lioroofrepairs" -- start
            echo "✅ Deployment completed successfully!"

      - name: Deployment notification
        if: success()
        run: echo "✅ Deployment to Plesk completed successfully!"

      - name: Deployment failed notification
        if: failure()
        run: echo "❌ Deployment failed. Check logs for details."
